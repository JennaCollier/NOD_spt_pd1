---
title: "2_figure1_plots"
output: rmarkdown::github_document
date: '2022-07-10'
---

The purpose of this figure is to show the single cell transcriptional landscape of CD4+ and CD8+ T cells during spontaneous and checkpoint-induced T1D in NOD mice.

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "C:/Users/Strix/GitRepos/NOD_spt_pd1")
knitr::opts_knit$set(echo = TRUE, root.dir = "C:/Users/Strix/GitRepos/NOD_spt_pd1")
```

```{r libraries, message = FALSE, warning = FALSE}
require(dplyr, quietly = T) #simple manipulation of data.frames
require(Seurat, quietly = T) #scRNA-seq analysis
require(reshape, quietly = T) #melting and casting data.frames
require(ggplot2, quietly = T) #plotting
require(rstatix, quietly = T) #adding p values to plots
require(ggprism, quietly = T) #adding p values to plots
require(ggsci, quirtly = T) #IGV color palette
require(patchwork, quietly = T) #adding p values to plots
require(magrittr, quietly = T) #adding p values to plots
require(gridExtra, quietly = T) #display multiple plots
require(ggrepel, quietly = T) #labels for plots
require(tibble, quietly = T) #rownames_to_column function
require(useful, quietly = T) #corner function to peek at data.frames
require(viridis, quietly = T) #viridis color palettes
require(readxl, quietly = T) #reading Excel files
source("scripts/utils.R") #custom color palettes and other functions
set.seed(1) #set a seed for reproducibility
```

```{r read in Seurats}
seurat_integrated <- saveRDS("objects/seurat_integrated_clustered.rds")
```

First, all of the T cells (both CD4 and CD8) will be clustered on a single UMAP. Additional UMAPs showing distribution of tissues, treatment groups, cell types, and clonotype expansion are also plotted to show the distribution of the samples. To label the initial UMAP with the Seurat clusters, the centroids of each cluster must be measured.
```{r Improved cluster UMAP}
#define the centroids for labeling the clusters
integrated_cls <- seurat_integrated@meta.data %>% 
                    dplyr::select(allcells_UMAP_1, 
                                  allcells_UMAP_2, 
                                  seurat_clusters) %>% 
                    group_by(seurat_clusters) %>% 
                    summarise(U1 = mean(allcells_UMAP_1),
                              U2 = mean(allcells_UMAP_2)) %>% 
                    data.frame()
integrated_cls

#plot the UMAP from the integrated Seurat containing the cluster labels
p_allcells_cluster <- seurat_integrated@meta.data %>% 
                        ggplot(aes(x = allcells_UMAP_1, 
                                   y = allcells_UMAP_2, 
                                   color = seurat_clusters)) + 
                        geom_point(shape = 16, 
                                   alpha = 0.3) +
                        theme_minimal() +
                        theme(axis.title = element_blank(),
                              axis.text = element_blank(),
                              text = element_text(size = 15),
                              panel.grid = element_blank()) +
                        labs(color = NULL,
                             title = "All T cells") +
                        geom_label_repel(data = integrated_cls, #these centroids will change depending on Seurat used
                                         mapping = aes(x = U1,
                                                       y = U2, 
                                                       label = seurat_clusters), 
                                         size = 5, 
                                         min.segment.length = Inf, 
                                         show.legend = FALSE) +
                        guides(color = guide_legend(override.aes = list(alpha = 1, #custom legend key
                                                                      size = 5, 
                                                                      shape = 19))) + 
                        scale_color_manual(values = custom_colors("clusters"))

#plot the UMAP of the different treatment groups
p_treatment <- seurat_integrated@meta.data %>% 
                ggplot(aes(x = allcells_UMAP_1, 
                           y = allcells_UMAP_2, 
                           color = treatment)) + 
                geom_point(shape = 16, alpha = 0.3) +
                theme_minimal() +
                theme(axis.title = element_blank(),
                      axis.text = element_blank(),
                      panel.grid = element_blank(),
                      text = element_text(size = 15),
                      legend.position = c(0.1,0.1)) +
                labs(color = NULL,
                     title = "All T cells: Treatment groups") +
                guides(color = guide_legend(override.aes = list(alpha = 1, 
                                                              size = 5, 
                                                              shape = 19))) + 
                scale_color_manual(values = custom_colors("treatments"))

#plot the UMAP of the different tissues
p_tissues <- seurat_integrated@meta.data %>% 
    ggplot(aes(x = allcells_UMAP_1, 
               y = allcells_UMAP_2, 
               color = tissue)) + 
    geom_point(shape = 16, alpha = 0.3) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank(),
          text = element_text(size = 15),
          legend.position = c(0.1,0.1)) +
    labs(color = NULL,
         title = "All T cells: Tissues") +
    guides(color = guide_legend(override.aes = list(alpha = 1, 
                                                  size = 5, 
                                                  shape = 19))) + 
    scale_color_manual(values = custom_colors("tissues"))

#plot the UMAP of the different celltypes
p_celltypes <- seurat_integrated@meta.data %>% 
    ggplot(aes(x = allcells_UMAP_1, 
               y = allcells_UMAP_2, 
               color = celltype)) + 
    geom_point(shape = 16, alpha = 0.3) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank(),
          text = element_text(size = 15),
          legend.position = c(0.1,0.1)) +
    labs(color=NULL,
         title = "All T cells: Cell types") +
    guides(color = guide_legend(override.aes = list(alpha = 1, 
                                                  size = 5, 
                                                  shape = 19))) + 
    scale_color_manual(values = custom_colors("celltypes"))

#plot the UMAP of clonotype expansion
p_expansion <- seurat_integrated@meta.data %>% 
    ggplot(aes(x = allcells_UMAP_1, 
               y = allcells_UMAP_2, 
               color = log10(clonotype_count+1))) + 
    geom_point(shape = 16, alpha = 0.3) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank(),
          text = element_text(size = 15),
          legend.position = c(0.2, 0.1)) +
    labs(color=expression(log[10](clonotype~count+1)), #this puts the 10 as a subscript for the log10
         title = "All T cells: Clonotype expansion") +
    scale_color_viridis(direction = -1, option = "D") +
    guides(color = guide_colorbar(ticks = F)) #removes ticks from colorbar

grid.arrange(p_tissues, p_treatment, p_celltypes, p_expansion, nrow = 2)
```

Next, create a stacked bar chart showing the distribution of tissues in each Seurat cluster:
```{r stacked bar chart of tissues per seurat cluster}
p_tissue_per_seurat_cluster <- seurat_integrated@meta.data %>% 
    ggplot(aes(x = factor(seurat_clusters, 
                        levels = rev(levels(seurat_integrated$seurat_clusters))), #orders clusters properly
                        fill = tissue)) + 
    geom_bar(stat = "count", 
             position = "fill") + 
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                       expand = c(0, 0)) +
    theme_minimal() +
    theme(panel.grid = element_blank(),
          text = element_text(size = 15),
          legend.position = "right") +
    labs(title = "All T cells", 
         y = "Percent of Seurat Cluster", 
         x = NULL,
         color = "Tissue") +
    scale_fill_manual(values = custom_colors("tissues")) +
    coord_flip()
p_tissue_per_seurat_cluster
```

To plot a heatmap of genes of interest across the clusters in Morpheus, the following manually annotated list of genes of interest, **goi**, will be examined. The average expression for each cluster will be determined and this data will be used to plot in Morpheus (Broad institute). The average expression for every gene will be determined to plot the pearson correlations for the Seurat clusters across tissues as well. 
```{r heatmap data for Morpheus}
## average gene expression of each tissue for each cluster - for Pearson correlation
avgs <- as.data.frame(t(AverageExpression(seurat_integrated, 
                                          assay = "RNA", 
                                          group.by = c("tissue", "seurat_clusters"))$RNA)) #get average expression for each gene (column) in each tissue/cluster pair (row)
avgs <- avgs %>% rownames_to_column("tissue_and_cluster") #the generated rownames include the tissue and cluster
avgs <- avgs %>% 
          mutate(tissue = sapply(tissue_and_cluster, function(x) strsplit(x, "_")[[1]][1]), #parse the tissue out to a separate column
                 seurat_clusters = sapply(tissue_and_cluster, function(x) paste(strsplit(x, "_")[[1]][-1], collapse = "_"))) %>%  #parse the cluster name to a separate column
          relocate(tissue_and_cluster, tissue, seurat_clusters) #move columns to left of data frame
write.table(avgs, "output/seurat_cluster_avg_expression_all_genes_for_morpheus.tsv", sep = "\t", quote = F, row.names = F) #write the data to table

memory_genes <- c("Sell","Il7r","Bcl2","Lef1")
exh_genes <- c("Pdcd1","Havcr2","Lag3","Cd38","Ctla4","Tigit","Cd101","Ctla4","Tox","Tcf7","Slamf6")
surface <- c("Cd226","Icos","Cd28","Tnfsf9","Tnfsf4","Il2rb","Tnfsf14","Ifngr1","Entpd1","Nrn1")
eff_genes <- c("Ifng","Fasl","Gzma","Gzmk","Gzmb","Prf1","Tnfsf10","Tnf","Il2","Gzmm","Nkg7","Klrd1","Itgal","Klrg1")
tf <- c("Batf","Eomes","Bcl6","Stat1","Tbx21","Runx1","Runx3","Prdm1","Nfatc1","Id2","Nfkb2","Hif1a","Bach2","Id3","Satb1","Nfkb1","Tox2","Bcl6","Zeb2","Klf2","Klf6")
chemokines <- c("Cx3cr1","Ccl5","Ccl4","Ccl3","Cxcr5","Cxcr6","Cxcr3","Ccr7","Ccr9","Cxcl10","Ccr8","S1pr5","Xcl1")
apoptosis <- c("Casp3","Tnfsf11","Nr4a3","Nfkb1","Nlrp3")
proliferation <- c("Mki67","Stmn1","Birc5","Pclaf")
ifnstim <- c("Isg15","Ifi27l2a","Ifit1","Ifit3")

goi <- c(coinh,surface,eff,tf,chemokines,apoptosis,proliferation,ifnstim) #concatenate all of the genes of interest

## create a data frame of annotated genes based on function
goi_annot <- data.frame(gene = goi, 
           group = c(rep("coinhibtory",length(coinh)),
                     rep("surface",length(surface)),
                     rep("effector",length(eff)),
                     rep("TF",length(tf))
                     ,rep("chemokines",length(chemokines)),
                     rep("apoptosis",length(apoptosis)),
                     rep("proliferation",length(proliferation)),
                     rep("ifnstim",length(ifnstim))))

avgs <- as.data.frame(AverageExpression(seurat_integrated, 
                                        features = goi, 
                                        assay = "RNA", 
                                        group.by = "seurat_clusters")$RNA) #get average expression for each gene of interest
avgs <- avgs %>% rownames_to_column("gene")
avgs <- merge(goi_annot, avgs, by = "gene")
write.table(avgs, "output/seurat_cluster_avg_expression_curated_genes_for_morpheus.tsv", sep = "\t", quote = F, row.names = F) #write the data to table

#get the markers that can be used to define each cluster
seurat_markers <- FindAllMarkers(seurat_integrated, 
                                 min.pct = 0.25, 
                                 only.pos = T, 
                                 logfc.threshold = 0.25) %>%
                     group_by(cluster) %>%
                     filter(p_val_adj < 0.05) %>%
                     group_by(cluster) %>%
                     arrange(desc(avg_log2FC), .by_group = T) %>%
                     top_n(n = 50, 
                           wt = avg_log2FC)
saveRDS(seurat_markers, "objects/integrated_seurat_FindAllMarkers.rds")

avgs <- as.data.frame(AverageExpression(seurat_integrated, 
                                        assay = "RNA", 
                                        group.by = "seurat_clusters")$RNA) #get average expression for each gene (column) in each cluster (row)
avgs <- avgs %>% rownames_to_column("gene")

## write a table containing the top 20 DE genes for each cluster
top20_genes <- seurat_markers %>% group_by(cluster) %>%
                      arrange(desc(avg_log2FC), .by_group = T) %>%
                      top_n(n = 20, wt = avg_log2FC) %>%
                      dplyr::select(gene, cluster)

write.table(top20_genes, "output/integrated_seurat_FindAllMarkers_top20.tsv", quote = F, sep = "\t", row.names = F)
```